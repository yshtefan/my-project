-- Данная процедура может отрабатывать с помощью джоба, который можно настроить отрабатывать раз в час. 
-- При этом учтено, чтобы отрабатывалось не более 200000 строк за раз.
-- С помощью процедуры мы смотрим есть ли на полисе характеристика региона, если нет, то инсертим его, если есть, то обновляем на новое значение

create or replace procedure my_proc_1 as
vn  number:= 200000;
cnt number;
rn number;
begin
for a in 
   (select p.policy_id, td.new_value, td.processed
      from policy p
      join tmp_table td on td.policy = p.policy_id
   where td.processed = 'N') loop

   begin
    exit when vn = 0;
    savepoint sp1;

   select count(1)
     into cnt
    from characteristic c
  where c.policy = a.policy_id
    and c.code = 'REGION';

  begin

   if cnt = 0 then
      insert characteristic (id, policy, code, value)
      values (nextval, a.policy_id, 'REGION', a.new_value);
   else
      update characteristic
         set value = a.new_value
       where c.policy = a.policy_id
         and c.code = 'REGION'; 
  end if;

   update tmp_table set processed = 'Y', pdate = sysdate where policy = a.policy_id;
exception
when others then
     update tmp_table set logerror = DBMS_UTILITY.FORMAT_ERROR_STACK() where policy = a.policy_id;
end;

rn := rn + SQL%rowcount;

if rn = 10000 then
  commit;
end if; 

vn := vn - 1;
  exception
when others then
  rollback to sp1;
end;
end loop;
commit;
end;
