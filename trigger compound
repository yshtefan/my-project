CREATE OR REPLACE TRIGGER trg_insurance_status_full
FOR INSERT OR UPDATE ON insurance_policies
COMPOUND TRIGGER

  -- переменная для подсчёта обработанных строк
  v_row_count NUMBER := 0;

-- выполнение один раз перед операцией
BEFORE STATEMENT IS
BEGIN
  v_row_count := 0; -- инициализация счетчика
  DBMS_OUTPUT.PUT_LINE('Старт операции: обработка строк...');

END BEFORE STATEMENT;

-- для каждой строки перед внесением изменений
BEFORE ROW IS
BEGIN
  -- проверяем дату окончания и устанавливаем статус
  IF :NEW.end_date < trunc(SYSDATE) THEN
    :NEW.status := 'CANCELED';
  ELSE
    :NEW.status := 'ACTIVE';
  END IF;

  -- увеличиваем счетчик
  v_row_count := v_row_count + 1;
END BEFORE ROW;

------------------------

-- после каждой строки, для логирования или других действий
AFTER ROW IS
BEGIN
  DBMS_OUTPUT.PUT_LINE('Обновлён полис ID: '  :NEW.policy_id  ', статус: ' || :NEW.status);
END AFTER ROW;

------------------------

-- в конце всей операции
AFTER STATEMENT IS
BEGIN
  -- финальное сообщение о количестве обработанных строк
  DBMS_OUTPUT.PUT_LINE('Обработка завершена: обработано строк: ' || v_row_count);
END AFTER;

END trg_insurance_status_full;
